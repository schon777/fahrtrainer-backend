<!doctype html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Fahrschulfragen</title>
<style>
  body{font-family:sans-serif;margin:0}
  header{border-bottom:1px solid #ccc;padding:8px}
  nav a{margin-right:8px}
  main{padding:12px;display:flex;flex-direction:column;gap:12px}
  table{width:100%;border-collapse:collapse}
  th,td{border:1px solid #ccc;padding:6px;text-align:left}
  thead th{background:#f6f6f6}
  .row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
  .muted{color:#555}
  .error{color:#b91c1c}
  .success{color:#166534}
  .seg{border:1px solid #ccc; padding:8px;}
  .mode-switch label{margin-right:12px;cursor:pointer}
  textarea{width:100%;min-height:160px;padding:6px;border:1px solid #ccc;font-family:inherit}
  input[type="text"]{padding:6px;border:1px solid #ccc}
  select{padding:6px;border:1px solid #ccc}
  .bar{display:flex;justify-content:space-between;align-items:center}
  .toggle-btn, .ghost, button{background:transparent;border:1px solid #ccc;padding:6px 10px;cursor:pointer}
  .hidden{display:none}

  /* ===== Mobile-Optimierung (≤ 640px) ===== */
@media (max-width: 640px){
  /* Layout & Abstände */
  main{ padding:10px }
  .row{ flex-direction:column; align-items:stretch; gap:10px }
  .bar{ flex-direction:column; align-items:stretch; gap:8px }

  /* Navigation & Buttons: bessere Touch-Ziele */
  nav a{ display:inline-block; padding:10px 12px }
  button{ padding:10px 12px; min-height:44px } /* mind. Apple/Google-Empfehlung */

  /* Formulare: Inputs auf volle Breite */
  input[type="text"],
  input[type="date"],
  input[type="time"],
  select,
  textarea{ width:100% }

  /* Tabellen: horizontal scrollen statt umbrechen */
  table{ display:block; overflow-x:auto; -webkit-overflow-scrolling:touch }
  thead th, tbody td{ white-space:nowrap }

  /* Kalender: volle Breite & größere Zellen für Touch */
  #calendar{ width:100% }
  th, td{ padding:10px 6px }
  td{ min-width:36px; min-height:44px }  /* besser antippbar */
  td.markiert{ border-width:2px; border-radius:8px } /* runde Markierung auch auf kleinen Zellen */

  /* Trainer: Optionen schön einspaltig */
  .choices{ display:grid; grid-template-columns:1fr; gap:8px }
  .letters{ gap:8px }
  .slot, .letter{ min-width:36px; padding:8px } /* bessere Trefferfläche */

  /* Fragen-/Kurs-Tabellen: Aktionen umbrechen */
  .actions button{ margin:4px 2px }
}

</style>
</head>
<body>
<header>
  <nav>
    <a href="main.html">Main</a>
    <a href="kalender.html">Kalender</a>
    <a href="fahrschulfragen.html" aria-current="page">Fahrschulfragen</a>
  </nav>
</header>

<main>
  <!-- ===== KURSE ===== -->
  <div id="kurse-block">
    <div class="bar">
      <h2 style="margin:0">Kurse</h2>
      <div class="row">
        <button id="export-all" class="ghost">Daten exportieren</button>
        <button id="kurs-add">Kurs hinzufügen</button>
        <button id="kurs-abbrechen" title="Auswahl zurücksetzen">Abbrechen</button>
        <button id="kurse-toggle" class="toggle-btn" aria-expanded="true">▼ einklappen</button>
      </div>
    </div>
    <div id="kurse-content">
      <div class="row" id="kurs-form-wrap" hidden>
        <label>Kursname <input type="text" id="kurs-name"></label>
        <button id="kurs-save">Speichern</button>
        <button id="kurs-cancel">Abbrechen</button>
      </div>
      <table id="kurse-table" style="margin-top:8px;">
        <thead><tr><th>Kurs</th><th>#Themen</th><th>Fragen</th><th>Aktionen</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ===== THEMEN ===== -->
  <div id="themen-block" hidden>
    <div class="bar" style="margin-top:8px;">
      <h3 style="margin:0">Themen – <span id="themen-kursname" class="muted"></span></h3>
      <div class="row">
        <button id="thema-add">Thema hinzufügen</button>
        <button id="thema-abbrechen" title="Thema-Auswahl zurücksetzen">Abbrechen</button>
        <button id="themen-toggle" class="toggle-btn" aria-expanded="true">▼ einklappen</button>
      </div>
    </div>
    <div id="themen-content">
      <div class="row" id="thema-form-wrap" hidden>
        <label>Thema <input type="text" id="thema-name"></label>
        <button id="thema-save">Speichern</button>
        <button id="thema-cancel">Abbrechen</button>
      </div>
      <table id="themen-table" style="margin-top:8px;">
        <thead><tr><th>Thema</th><th>#Fragen</th><th>Aktionen</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- ===== FRAGEN ===== -->
  <div id="fragen-block" hidden>
    <div class="bar" style="margin-top:8px;">
      <h3 style="margin:0">Fahrschulfragen – <span id="fragen-thema" class="muted"></span></h3>
      <div class="row">
        <button id="frage-add">Frage hinzufügen</button>
        <button id="fragen-abbrechen" title="Fragen-Bereich ausblenden">Abbrechen</button>
        <button id="fragen-toggle" class="toggle-btn" aria-expanded="true">▼ einklappen</button>
      </div>
    </div>
    <div id="fragen-content">
      <div id="frage-add-wrap" class="seg" hidden>
        <div class="row">
          <label>Kurs <select id="sel-course"></select></label>
          <label>Thema <select id="sel-topic"></select></label>
          <span id="ctx-msg" class="muted"></span>
        </div>

        <div class="mode-switch row" style="margin-top:6px;">
          <label><input type="radio" name="frage-mode" value="manual" checked> Manuell</label>
          <label><input type="radio" name="frage-mode" value="bulk"> Text-Import</label>
        </div>

        <!-- Manuell -->
        <div id="frage-form-wrap" class="row" style="margin-top:8px;">
          <label>Frage <input type="text" id="frage-text" style="width:24em"></label>
          <label>Antwort <input type="text" id="frage-antwort" style="width:24em"></label>
          <button id="frage-save">Speichern</button>
          <button id="frage-cancel">Abbrechen</button>
        </div>

        <!-- Text-Import -->
        <div id="frage-import-wrap" class="hidden" style="margin-top:8px;">
<textarea id="bulk-text" placeholder="Format:
Frage: ...
Antwort: ...

Beispiel:
Frage: Was ist VLAN?
Antwort: Virtuelles lokales Netzwerk zur Segmentierung."></textarea>
          <div class="row" style="margin-top:6px;">
            <button id="bulk-parse">Importieren</button>
            <button id="bulk-cancel">Abbrechen</button>
            <span id="bulk-msg" class="muted"></span>
          </div>
        </div>
      </div>

      <table id="fragen-table" style="margin-top:8px;">
        <thead><tr><th>Frage</th><th>Antwort</th><th>Aktionen</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</main>

<script>
  const KEY_KURSE="kurse-v1", KEY_THEMEN="themen-v1", KEY_FRAGEN="fragen-v1";
  const load=(k,d=[])=>{try{const v=JSON.parse(localStorage.getItem(k));return v??d;}catch{return d;}};
  const save=(k,v)=>localStorage.setItem(k,JSON.stringify(v));
  const uid=()=>Math.random().toString(36).slice(2)+Date.now().toString(36);
  const escapeHtml=s=>String(s).replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

  let selectedCourseId=null, selectedTopicId=null;

  // Toggle helpers
  function toggle(btn,content){
    const exp=btn.getAttribute('aria-expanded')==="true";
    btn.setAttribute('aria-expanded',!exp);
    btn.textContent=!exp?"▼ einklappen":"▶ ausklappen";
    content.hidden=exp;
  }
  document.getElementById('kurse-toggle').onclick=()=>toggle(document.getElementById('kurse-toggle'),document.getElementById('kurse-content'));
  document.getElementById('themen-toggle').onclick=()=>toggle(document.getElementById('themen-toggle'),document.getElementById('themen-content'));
  document.getElementById('fragen-toggle').onclick=()=>toggle(document.getElementById('fragen-toggle'),document.getElementById('fragen-content'));

  // Abbrechen Buttons
  const themenBlock=document.getElementById('themen-block');
  const fragenBlock=document.getElementById('fragen-block');
  const themenKursname=document.getElementById('themen-kursname');
  const fragenThema=document.getElementById('fragen-thema');

  document.getElementById('kurs-abbrechen').onclick=()=>{
    selectedCourseId=null; selectedTopicId=null;
    themenBlock.hidden=true; fragenBlock.hidden=true;
    themenKursname.textContent=""; fragenThema.textContent="";
    document.getElementById('thema-form-wrap').hidden=true;
    document.getElementById('frage-add-wrap').hidden=true;
  };
  document.getElementById('thema-abbrechen').onclick=()=>{
    selectedTopicId=null; fragenBlock.hidden=true; fragenThema.textContent="";
    document.getElementById('frage-add-wrap').hidden=true;
  };
  document.getElementById('fragen-abbrechen').onclick=()=>{
    fragenBlock.hidden=true; document.getElementById('frage-add-wrap').hidden=true;
  };

  // Export
  document.getElementById('export-all').onclick=()=>{
    const data={kurse:load(KEY_KURSE),themen:load(KEY_THEMEN),fragen:load(KEY_FRAGEN)};
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download="fahrschulfragen.json";a.click();
  };

  // ===== Kurse =====
  const kurseTable=document.querySelector('#kurse-table tbody');
  const kursFormWrap=document.getElementById('kurs-form-wrap');
  document.getElementById('kurs-add').onclick=()=>{kursFormWrap.hidden=false;document.getElementById('kurs-name').value="";};
  document.getElementById('kurs-cancel').onclick=()=>{kursFormWrap.hidden=true;};
  document.getElementById('kurs-save').onclick=()=>{
    const name=document.getElementById('kurs-name').value.trim();if(!name)return;
    const kurse=load(KEY_KURSE);kurse.push({id:uid(),name});save(KEY_KURSE,kurse);
    kursFormWrap.hidden=true;renderCourses();refreshSelectors();
  };

  function renderCourses(){
    const kurse=load(KEY_KURSE),themen=load(KEY_THEMEN),fragen=load(KEY_FRAGEN);
    kurseTable.innerHTML="";
    kurse.forEach(k=>{
      const kThemen=themen.filter(t=>t.courseId===k.id);
      const kFragen=fragen.filter(f=>f.courseId===k.id);
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${escapeHtml(k.name)}</td><td>${kThemen.length}</td><td>${kFragen.length}</td>
      <td><button data-sel="${k.id}">Auswählen</button><button data-del="${k.id}">Löschen</button></td>`;
      tr.querySelector('[data-sel]').onclick=()=>{
        selectedCourseId=k.id;themenBlock.hidden=false;
        fragenBlock.hidden=true;selectedTopicId=null;
        themenKursname.textContent=k.name;renderTopics();
        refreshSelectors();
      };
      tr.querySelector('[data-del]').onclick=()=>{
        if(!confirm("Kurs löschen?"))return;
        save(KEY_KURSE,kurse.filter(x=>x.id!==k.id));
        save(KEY_THEMEN,themen.filter(t=>t.courseId!==k.id));
        save(KEY_FRAGEN,fragen.filter(f=>f.courseId!==k.id));
        renderCourses();themenBlock.hidden=true;fragenBlock.hidden=true;
      };
      kurseTable.appendChild(tr);
    });
  }

  // ===== Themen =====
  const themenTable=document.querySelector('#themen-table tbody');
  document.getElementById('thema-add').onclick=()=>{document.getElementById('thema-form-wrap').hidden=false;};
  document.getElementById('thema-cancel').onclick=()=>{document.getElementById('thema-form-wrap').hidden=true;};
  document.getElementById('thema-save').onclick=()=>{
    const name=document.getElementById('thema-name').value.trim();if(!name)return;
    const themen=load(KEY_THEMEN);themen.push({id:uid(),courseId:selectedCourseId,name});
    save(KEY_THEMEN,themen);document.getElementById('thema-form-wrap').hidden=true;renderTopics();refreshSelectors();
  };

  function renderTopics(){
    const themen=load(KEY_THEMEN).filter(t=>t.courseId===selectedCourseId);
    const fragen=load(KEY_FRAGEN);
    themenTable.innerHTML="";
    themen.forEach(t=>{
      const tFragen=fragen.filter(f=>f.topicId===t.id);
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${escapeHtml(t.name)}</td><td>${tFragen.length}</td>
      <td><button data-sel="${t.id}">Auswählen</button><button data-del="${t.id}">Löschen</button></td>`;
      tr.querySelector('[data-sel]').onclick=()=>{
        selectedTopicId=t.id;fragenBlock.hidden=false;
        fragenThema.textContent=t.name;renderQuestions();
        refreshSelectors();
      };
      tr.querySelector('[data-del]').onclick=()=>{
        if(!confirm("Thema löschen?"))return;
        save(KEY_THEMEN,load(KEY_THEMEN).filter(x=>x.id!==t.id));
        save(KEY_FRAGEN,load(KEY_FRAGEN).filter(f=>f.topicId!==t.id));
        renderTopics();fragenBlock.hidden=true;
      };
      themenTable.appendChild(tr);
    });
  }

  // ===== Fragen =====
  const fragenTable=document.querySelector('#fragen-table tbody');
  const frageAddWrap=document.getElementById('frage-add-wrap');

  document.getElementById('frage-add').onclick=()=>{
    if(!selectedCourseId){alert("Bitte zuerst einen Kurs auswählen.");return;}
    if(!selectedTopicId){alert("Bitte zuerst ein Thema auswählen.");return;}
    frageAddWrap.hidden=false;
    refreshSelectors();
    updateCtxMsg();
  };

  document.getElementById('frage-cancel').onclick=()=>{frageAddWrap.hidden=true;};
  document.getElementById('frage-save').onclick=()=>{
    if(!ensureSelection())return;
    const frage=document.getElementById('frage-text').value.trim();
    const antwort=document.getElementById('frage-antwort').value.trim();
    if(!frage){alert("Frage darf nicht leer sein.");return;}
    const all=load(KEY_FRAGEN);
    all.push({id:uid(),courseId:selectedCourseId,topicId:selectedTopicId,frage,antwort});
    save(KEY_FRAGEN,all);
    document.getElementById('frage-text').value="";
    document.getElementById('frage-antwort').value="";
    renderQuestions();renderCourses();updateCtxMsg(true);
  };

  function renderQuestions(){
    const qs=load(KEY_FRAGEN).filter(f=>f.topicId===selectedTopicId);
    fragenTable.innerHTML="";
    qs.forEach(q=>{
      const tr=document.createElement('tr');
      tr.innerHTML=`<td>${escapeHtml(q.frage)}</td><td>${escapeHtml(q.antwort)}</td>
      <td><button data-del="${q.id}">Löschen</button></td>`;
      tr.querySelector('[data-del]').onclick=()=>{
        if(!confirm("Frage löschen?"))return;
        save(KEY_FRAGEN,load(KEY_FRAGEN).filter(x=>x.id!==q.id));
        renderQuestions();renderCourses();
      };
      fragenTable.appendChild(tr);
    });
  }

  // ===== Text-Import Logik =====
  const modeRadios=document.querySelectorAll('input[name="frage-mode"]');
  const formWrap=document.getElementById('frage-form-wrap');
  const importWrap=document.getElementById('frage-import-wrap');
  const bulkText=document.getElementById('bulk-text');
  const bulkMsg=document.getElementById('bulk-msg');

  modeRadios.forEach(r=>{
    r.addEventListener('change',()=>{
      const mode=getMode();
      if(mode==='manual'){formWrap.classList.remove('hidden');importWrap.classList.add('hidden');}
      else{formWrap.classList.add('hidden');importWrap.classList.remove('hidden');}
      bulkMsg.textContent="";
    });
  });
  function getMode(){ return Array.from(modeRadios).find(r=>r.checked)?.value || 'manual'; }

  document.getElementById('bulk-cancel').onclick=()=>{ bulkText.value=""; bulkMsg.textContent=""; frageAddWrap.hidden=true; };

  document.getElementById('bulk-parse').onclick=()=>{
    bulkMsg.className='muted';
    if(!ensureSelection()) return;
    const txt=bulkText.value||"";
    const lines=txt.split(/\r?\n/);
    const items=[];
    let currQ=null, currA=null;

    const flush=()=>{
      if(currQ && (currA!==null)){
        items.push({frage:currQ.trim(), antwort:(currA||"").trim()});
      }
      currQ=null; currA=null;
    };

    for(const raw of lines){
      const line=raw.trim();
      if(line.toLowerCase().startsWith("frage:")){
        flush();
        currQ=line.slice(6).trim();
      }else if(line.toLowerCase().startsWith("antwort:")){
        currA=line.slice(8).trim();
      }else if(line===""){
        // Leerzeile -> evtl. Datensatz abschließen
        flush();
      }else{
        // sonstige Zeilen anhängen (Mehrzeiler erlauben)
        if(currA!==null && currQ){ currA += (currA? "\n":"") + line; }
        else if(currQ){ currQ += (currQ? " ":"") + line; }
      }
    }
    flush();

    // filtern leere
    const ready=items.filter(x=>x.frage);
    if(ready.length===0){ bulkMsg.textContent="Keine gültigen Einträge gefunden. Prüfe das Format."; bulkMsg.className='error'; return; }

    const all=load(KEY_FRAGEN);
    ready.forEach(x=>{
      all.push({id:uid(),courseId:selectedCourseId,topicId:selectedTopicId,frage:x.frage,antwort:x.antwort||""});
    });
    save(KEY_FRAGEN,all);
    bulkMsg.textContent=`Import erfolgreich: ${ready.length} Frage(n) hinzugefügt.`;
    bulkMsg.className='success';
    renderQuestions();renderCourses();
  };

  // ===== Selektoren in der Eingabe
  const selCourse=document.getElementById('sel-course');
  const selTopic=document.getElementById('sel-topic');
  selCourse.addEventListener('change',()=>{
    selectedCourseId=selCourse.value||null;
    fillTopicsSelector();
    updateCtxMsg();
  });
  selTopic.addEventListener('change',()=>{
    selectedTopicId=selTopic.value||null;
    updateCtxMsg();
  });

  function ensureSelection(){
    if(!selectedCourseId){alert("Bitte Kurs wählen.");return false;}
    if(!selectedTopicId){alert("Bitte Thema wählen.");return false;}
    return true;
    }

  function updateCtxMsg(ok=false){
    const kurse=load(KEY_KURSE); const themen=load(KEY_THEMEN);
    const k=kurse.find(k=>k.id===selectedCourseId);
    const t=themen.find(t=>t.id===selectedTopicId);
    document.getElementById('ctx-msg').textContent = (k&&t)
      ? `Ziel: ${k.name} → ${t.name}` + (ok? " ✔ gespeichert":"")
      : "Bitte Kurs und Thema wählen.";
  }

  function fillCoursesSelector(){
    const kurse=load(KEY_KURSE);
    selCourse.innerHTML="";
    if(kurse.length===0){ selCourse.innerHTML="<option value=''>-- kein Kurs --</option>"; return; }
    kurse.forEach(k=>{
      const o=document.createElement('option'); o.value=k.id; o.textContent=k.name; selCourse.appendChild(o);
    });
    if(selectedCourseId){ selCourse.value=selectedCourseId; }
  }
  function fillTopicsSelector(){
    const themen=load(KEY_THEMEN).filter(t=>t.courseId===selectedCourseId);
    selTopic.innerHTML="";
    if(themen.length===0){ selTopic.innerHTML="<option value=''>-- kein Thema --</option>"; return; }
    themen.forEach(t=>{
      const o=document.createElement('option'); o.value=t.id; o.textContent=t.name; selTopic.appendChild(o);
    });
    if(selectedTopicId){ selTopic.value=selectedTopicId; }
  }
  function refreshSelectors(){
    fillCoursesSelector();
    fillTopicsSelector();
  }

  // Init
  function init(){
    renderCourses();
  }
  init();
</script>
</body>
</html>
