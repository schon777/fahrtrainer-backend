<!doctype html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Fahrtrainer</title>
  <style>
    :root { color-scheme: light dark; }
    body { font-family: system-ui, Arial, sans-serif; margin: 24px; max-width: 960px }
    h1 { margin: 0 0 12px 0 }
    .card { padding: 16px; border: 1px solid #ddd; border-radius: 12px; margin: 12px 0 }
    form input, form button { padding: 10px; margin-right: 8px; margin-bottom: 8px }
    ul { padding-left: 18px }
    .ok { color: #2e7d32 } .bad { color: #c62828 } .muted{opacity:.8}
    button { cursor: pointer }
    li { margin: 6px 0; display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .grow { flex: 1 1 auto; min-width: 240px }
    code { background: #f6f8fa; padding: 2px 6px; border-radius: 6px }
  </style>
</head>
<body>
  <h1>Fahrtrainer</h1>

  <div class="card" id="status">
    <strong>Status</strong>
    <div>Backend: <span id="ping" class="muted">prüfe…</span></div>
    <div>DB: <span id="db" class="muted">prüfe…</span></div>
    <div>API: <code id="apiurl"></code></div>
    <div>DB Host: <span id="dbhost" class="muted">prüfe…</span></div>
    <div style="margin-top:8px;">
      <button id="refresh">Neu laden</button>
    </div>
  </div>

  <div class="card">
    <h2>Neue Fahrt speichern</h2>
    <form id="form">
      <input id="start" placeholder="Startort" required />
      <input id="ziel"  placeholder="Zielort" required />
      <input id="dauer" placeholder="Dauer (min)" type="number" min="0" />
      <button>Speichern</button>
    </form>
  </div>

  <div class="card">
    <h2>Letzte Fahrten</h2>
    <ul id="list"></ul>
  </div>

  <script>
    // >>> Deine Backend-URL (Render)
    const API = "https://fahrtrainer-backend.onrender.com";

    // ---- kleine Helfer
    const $ = sel => document.querySelector(sel);
    function escapeHtml(s){ return (s ?? "").replace(/[&<>"]/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    function noStore(url){
      const u = new URL(url, location.href);
      u.searchParams.set("t", Date.now()); // Cache-Buster
      return fetch(u.toString(), { cache: "no-store" });
    }

    // ---- Status/Health
    async function health() {
      $("#apiurl").textContent = API;

      try {
        const r = await noStore(`${API}/api/ping`);
        $("#ping").textContent = r.ok ? "OK" : "Fehler";
        $("#ping").className = r.ok ? "ok" : "bad";
      } catch {
        $("#ping").textContent = "Fehler";
        $("#ping").className = "bad";
      }

      try {
        const r = await noStore(`${API}/api/time`);
        $("#db").textContent = r.ok ? "OK" : "Fehler";
        $("#db").className = r.ok ? "ok" : "bad";
      } catch {
        $("#db").textContent = "Fehler";
        $("#db").className = "bad";
      }

      // DB-Host anzeigen (optional; Route ist in app.py vorhanden)
      try {
        const r = await noStore(`${API}/api/debug/db`);
        if (r.ok) {
          const d = await r.json();
          $("#dbhost").textContent = d.host || "n/a";
          $("#dbhost").className = "muted";
        } else {
          $("#dbhost").textContent = "n/a";
        }
      } catch { $("#dbhost").textContent = "n/a"; }
    }

    // ---- Liste rendern
    function render(items){
      const list = $("#list");
      if (!items.length) { list.innerHTML = "<li class='muted'>Noch keine Einträge.</li>"; return; }
      list.innerHTML = items.map(x => `
        <li data-id="${x.id}"
            data-start="${encodeURIComponent(x.start)}"
            data-ziel="${encodeURIComponent(x.ziel)}"
            data-dauer="${x.dauer_minutes ?? ''}">
          <span class="grow">#${x.id} ${escapeHtml(x.start)} → ${escapeHtml(x.ziel)}
            (${x.dauer_minutes ?? "-"} min) – ${new Date(x.created_at).toLocaleString()}</span>
          <button class="edit">Bearbeiten</button>
          <button class="del">Löschen</button>
        </li>
      `).join("");
    }

    // ---- Daten laden (No-Cache)
    async function load(){
      try {
        const res = await noStore(`${API}/api/fahrten`);
        if (!res.ok) { $("#list").innerHTML = "<li class='bad'>Fehler beim Laden.</li>"; return; }
        const data = await res.json();
        render(data.items || []);
      } catch {
        $("#list").innerHTML = "<li class='bad'>Netzwerkfehler beim Laden.</li>";
      }
    }

    // ---- Neu anlegen
    async function addFahrt(e){
      e.preventDefault();
      const start = $("#start").value.trim();
      const ziel  = $("#ziel").value.trim();
      const dauer = $("#dauer").value ? parseInt($("#dauer").value, 10) : null;
      if(!start || !ziel){ alert("Bitte Start und Ziel angeben."); return; }

      try {
        const r = await fetch(`${API}/api/fahrten`, {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify({ start, ziel, dauer_minutes: isNaN(dauer) ? null : dauer })
        });
        if(!r.ok){ const t = await r.text(); alert("Fehler beim Speichern: " + t); return; }
        $("#form").reset();
        await load();
      } catch {
        alert("Netzwerkfehler beim Speichern");
      }
    }

    // ---- Edit/Delete via Event-Delegation
    $("#list").addEventListener("click", async (e)=>{
      const li = e.target.closest("li[data-id]");
      if(!li) return;
      const id = li.dataset.id;

      if(e.target.classList.contains("del")){
        if(!confirm(`Fahrt #${id} löschen?`)) return;
        const r = await fetch(`${API}/api/fahrten/${id}`, { method: "DELETE" });
        if(!r.ok){ alert("Löschen fehlgeschlagen"); return; }
        await load();
      }

      if(e.target.classList.contains("edit")){
        const curStart = decodeURIComponent(li.dataset.start);
        const curZiel  = decodeURIComponent(li.dataset.ziel);
        const curDauer = li.dataset.dauer || "";
        const nStart = prompt("Neuer Start:", curStart); if(nStart===null) return;
        const nZiel  = prompt("Neues Ziel:",  curZiel);  if(nZiel===null)  return;
        const nDauer = prompt("Neue Dauer (min, leer=unverändert):", curDauer);
        const payload = {
          start: nStart.trim(),
          ziel:  nZiel.trim(),
          dauer_minutes: nDauer === "" ? null : parseInt(nDauer,10)
        };
        const r = await fetch(`${API}/api/fahrten/${id}`, {
          method:"PUT",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });
        if(!r.ok){ alert("Ändern fehlgeschlagen"); return; }
        await load();
      }
    });

    // ---- Init
    window.addEventListener("DOMContentLoaded", () => {
      $("#form").addEventListener("submit", addFahrt);
      $("#refresh").addEventListener("click", async () => { await load(); await health(); });
      health();
      load();
    });
  </script>
</body>
</html>
